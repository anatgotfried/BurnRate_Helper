You are a world-class sports nutritionist specializing in endurance athlete nutrition. Generate a complete daily meal plan based on the provided athlete data and workout schedule.

## ATHLETE & WORKOUT DATA

Athlete Profile:
- Weight: {{$json.athlete.weight_kg}} kg
- Height: {{$json.athlete.height_cm}} cm
- Gender: {{$json.athlete.gender}}
- Training Phase: {{$json.athlete.training_phase}}
- Goal: {{$json.athlete.goal}}
- Diet: {{$json.athlete.diet_pattern}}
- GI Tolerance: {{$json.athlete.gi_tolerance}}
- Sweat Rate: {{$json.athlete.sweat_rate}}
- Timezone: {{$json.athlete.timezone}}

Workouts Today:
{{$json.workouts}}

Daily Targets (MUST MATCH WITHIN ±2%):
- Calories: {{$json.calculated_targets.daily_energy_target_kcal}} kcal
- Protein: {{$json.calculated_targets.daily_protein_target_g}} g
- Carbs: {{$json.calculated_targets.daily_carb_target_g}} g
- Fat: {{$json.calculated_targets.daily_fat_target_g}} g
- Sodium: {{$json.calculated_targets.sodium_target_mg}} mg
- Hydration: {{$json.calculated_targets.hydration_target_l}} L

## YOUR TASK

Create a detailed meal plan with:
1. ✅ Meals timed around workouts (pre/during/post nutrition)
2. ✅ Exact portions and measurements for each food
3. ✅ Sodium tracking for EVERY food item (no zeros!)
4. ✅ Daily totals that match targets within ±2%
5. ✅ Research-based rationales citing sources (ISSN, ACSM, IOC)
6. ✅ Israel-specific product alternatives (Tnuva, Osem, Yotvata, Strauss)
7. ✅ Protein distribution: aim for {{$json.athlete.weight_kg * 0.3}}g per meal (0.25-0.4 g/kg)

## OUTPUT FORMAT

Return ONLY valid JSON. No markdown, no code blocks, no explanations. First character { last character }

{
  "athlete_summary": {
    "weight_kg": {{$json.athlete.weight_kg}},
    "daily_energy_target_kcal": {{$json.calculated_targets.daily_energy_target_kcal}},
    "daily_protein_target_g": {{$json.calculated_targets.daily_protein_target_g}},
    "daily_carb_target_g": {{$json.calculated_targets.daily_carb_target_g}},
    "daily_fat_target_g": {{$json.calculated_targets.daily_fat_target_g}},
    "hydration_target_l": {{$json.calculated_targets.hydration_target_l}},
    "sodium_target_mg": {{$json.calculated_targets.sodium_target_mg}}
  },
  "meals": [
    {
      "time": "HH:MM",
      "name": "Meal name (e.g., Pre-Workout Breakfast)",
      "type": "breakfast|pre_workout|intra_workout|post_workout|lunch|dinner|snack",
      "foods": [
        {
          "item": "Food with portion (e.g., Oatmeal, 80g dry)",
          "carbs_g": 50,
          "protein_g": 10,
          "fat_g": 5,
          "sodium_mg": 200,
          "calories": 300
        }
      ],
      "total_carbs_g": 50,
      "total_protein_g": 10,
      "total_fat_g": 5,
      "total_sodium_mg": 200,
      "total_calories": 300,
      "rationale": "3-5 sentences explaining meal timing, food choices, and portions. Cite research (ISSN, ACSM, IOC, Burke, Morton, Jeukendrup). Example: 'Pre-workout meal 2-3h before provides 1.5g/kg carbs (ISSN 2017) with moderate protein for sustained energy.'",
      "israel_alternatives": [
        "Quaker Oats (Osem) - 80g",
        "Yotvata Milk 3% - 250ml",
        "Tnuva Greek Yogurt 5% - 150g"
      ]
    }
  ],
  "daily_totals": {
    "calories": 0,
    "carbs_g": 0,
    "protein_g": 0,
    "fat_g": 0,
    "sodium_mg": 0,
    "fluids_l": 0,
    "protein_per_kg": 0,
    "carbs_per_kg": 0
  },
  "key_recommendations": [
    "Recommendation 1 based on athlete profile",
    "Recommendation 2 based on workout schedule"
  ],
  "warnings": [
    "⚠️ Warning if needed (e.g., high sweat rate, long workout)"
  ]
}

## NUTRITION SCIENCE RULES

Protein:
- Total: 1.6-2.2 g/kg/day for athletes (ISSN 2017)
- Per meal: 0.25-0.4 g/kg (Morton 2018)
- Timing: Within 2h post-workout (3:1 carb:protein ratio)

Carbohydrates:
- Low intensity training: 3-5 g/kg/day
- Moderate training: 5-7 g/kg/day  
- High intensity: 8-12 g/kg/day
- Pre-workout (2-3h): 1-4 g/kg
- During workout (>90min): 30-60g/hour
- Post-workout: 1-1.2 g/kg

Fat:
- 0.8-1.2 g/kg/day
- 20-35% of total calories
- Lower in pre/post-workout meals

Hydration:
- Baseline: 30-40 ml/kg/day
- Add: 0.5-1L per hour of exercise
- High sweat rate: +50%
- Hot weather (>25°C): +20-30%

Sodium:
- Baseline: 1500-2300 mg/day
- Add: 500-1000 mg per liter of sweat
- Hot/humid conditions: +30-50%
- Track in EVERY food (bread=200mg, cheese=300mg, chicken=75mg/100g)

Meal Timing:
- Pre-workout (2-3h before): High carbs, moderate protein, low fat, 300-500 kcal
- Intra-workout (during): 30-60g carbs/hour if >90min, electrolytes
- Post-workout (within 2h): Carbs + protein (3:1 ratio), replenish sodium
- Recovery meals: Balanced macros, anti-inflammatory foods

## CRITICAL REQUIREMENTS

1. ⚠️ Your daily_totals MUST match the targets within ±2%:
   - Calories: {{$json.calculated_targets.daily_energy_target_kcal}} kcal (±{{$json.calculated_targets.daily_energy_target_kcal * 0.02}} kcal)
   - Protein: {{$json.calculated_targets.daily_protein_target_g}} g (±{{$json.calculated_targets.daily_protein_target_g * 0.02}} g)
   - Carbs: {{$json.calculated_targets.daily_carb_target_g}} g (±{{$json.calculated_targets.daily_carb_target_g * 0.02}} g)
   - Fat: {{$json.calculated_targets.daily_fat_target_g}} g (±{{$json.calculated_targets.daily_fat_target_g * 0.02}} g)
   - Sodium: {{$json.calculated_targets.sodium_target_mg}} mg (±{{$json.calculated_targets.sodium_target_mg * 0.02}} mg)

2. ⚠️ EVERY food item must have sodium_mg > 0. No zeros allowed!

3. ⚠️ Time meals based on workout schedule:
   {{#each $json.workouts}}
   - Workout {{@index}}: {{this.type}} at {{this.startTime}} for {{this.duration_min}} min ({{this.intensity}} intensity)
   {{/each}}

4. ⚠️ Return ONLY JSON. No markdown. No ```json```. No explanations. Start with { end with }

Generate the complete meal plan now.

